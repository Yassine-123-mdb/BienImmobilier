<div class="container mt-4">
  <h2 class="mb-4">Gestion des Utilisateurs</h2>

  <!-- Barre de recherche -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <input 
          type="text" 
          [(ngModel)]="searchQuery" 
          class="form-control" 
          placeholder="Rechercher par nom, prénom ou email..."
          (keyup.enter)="applyFilters()"
        >
        <button class="btn btn-outline-secondary" (click)="applyFilters()">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
    <div class="col-md-4">
      <select 
        [(ngModel)]="selectedRole" 
        class="form-select" 
        (change)="applyFilters()"
      >
        <option value="">Tous les rôles</option>
        <option value="ADMIN">Admin</option>
        <option value="PROPRIETAIRE">Propriétaire</option>
        <option value="CLIENT">Client</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" (click)="loadUsers()">
        <i class="bi bi-arrow-clockwise"></i> Actualiser
      </button>
    </div>
  </div>

  <!-- Tableau -->
  <div class="table-responsive">
    <table class="table table-hover table-bordered">
      <thead class="table-light">
        <tr>
          <th>Photo</th>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Email</th>
          <th>Rôle</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="isLoading">
          <td colspan="7" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </td>
        </tr>
        <tr *ngFor="let user of filteredUsers">
          <td>
            <img 
              [src]="user.imageUrls?.[0] || 'assets/default-user.png'" 
              alt="Photo profil" 
              class="rounded-circle user-avatar"
    
            >
          </td>
          <td>{{ user.nom }}</td>
          <td>{{ user.prenom }}</td>
          <td>{{ user.email }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'bg-danger': getMainRole(user.roles) === 'ADMIN',
              'bg-warning text-dark': getMainRole(user.roles) === 'PROPRIETAIRE',
              'bg-success': getMainRole(user.roles) === 'CLIENT'
            }">
              {{ getMainRole(user.roles) | lowercase }}
            </span>
          </td>
          <td>
            <span class="badge" [ngClass]="user.enabled ? 'bg-success' : 'bg-secondary'">
              {{ user.enabled ? 'Actif' : 'Inactif' }}
            </span>
          </td>
          <td>
            <div class="d-flex gap-2">
              <button 
                class="btn btn-sm btn-outline-danger" 
                (click)="deleteUser(user.id)"
              >
                <i class="bi bi-trash"></i>
              </button>
              <button 
                class="btn btn-sm" 
                [ngClass]="user.enabled ? 'btn-warning' : 'btn-success'"
                (click)="toggleStatus(user.id)"
              >
                <i class="bi" [ngClass]="user.enabled ? 'bi-lock' : 'bi-unlock'"></i>
              </button>
              <button 
                *ngIf="getMainRole(user.roles) === 'CLIENT'"
                class="btn btn-sm btn-info" 
                (click)="viewReservations(user.id)"
              >
                <i class="bi bi-calendar"></i>
              </button>
              <button 
                *ngIf="getMainRole(user.roles) === 'PROPRIETAIRE'"
                class="btn btn-sm btn-secondary" 
                (click)="viewAnnonces(user.id)"
              >
                <i class="bi bi-house"></i>
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="!isLoading && filteredUsers.length === 0">
          <td colspan="7" class="text-center py-4 text-muted">
            Aucun utilisateur trouvé
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <nav *ngIf="totalItems > itemsPerPage">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" (click)="onPageChange(currentPage - 1)">Précédent</a>
      </li>
      <li class="page-item" *ngFor="let page of getPages()" [class.active]="page === currentPage">
        <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === getLastPage()">
        <a class="page-link" (click)="onPageChange(currentPage + 1)">Suivant</a>
      </li>
    </ul>
  </nav>
</div>